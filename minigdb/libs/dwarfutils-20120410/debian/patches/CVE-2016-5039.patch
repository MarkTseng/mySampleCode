Description: Fix for CVE-2016-5039 (OOB read bug in get_attr_value())
Author: Fabian Wolff <fabi.wolff@arcor.de>
Origin: backport, https://sourceforge.net/p/libdwarf/code/ci/eb1472afac95031d0c9dd8c11d527b865fe7deb8/

--- a/libdwarf/dwarf_form.c
+++ b/libdwarf/dwarf_form.c
@@ -766,10 +766,17 @@
     Dwarf_Word leb128_length = 0;
     Dwarf_Block *ret_block = 0;
 
+    Dwarf_Unsigned section_length = 0;
+
     int res  = get_attr_dbg(&dbg,&cu_context,attr,error);
     if(res != DW_DLV_OK) { 
         return res;
-    } 
+    }
+
+    section_length = (cu_context->cc_is_info
+                      ? (&dbg->de_debug_info)
+                      : (&dbg->de_debug_types))->dss_size;
+
     switch (attr->ar_attribute_form) {
 
     case DW_FORM_block1:
@@ -801,11 +808,12 @@
     }
 
     /* Check that block lies within current cu in .debug_info. */
-    if (attr->ar_debug_ptr + length >=
-        dbg->de_debug_info.dss_data + cu_context->cc_debug_offset +
-        cu_context->cc_length + cu_context->cc_length_size +
-        cu_context->cc_extension_size) {
-        _dwarf_error(dbg, error, DW_DLE_ATTR_FORM_SIZE_BAD);
+    if ((attr->ar_debug_ptr + length >=
+         dbg->de_debug_info.dss_data + cu_context->cc_debug_offset +
+         cu_context->cc_length + cu_context->cc_length_size +
+         cu_context->cc_extension_size)
+        || (length >= section_length)) {
+            _dwarf_error(dbg, error, DW_DLE_ATTR_FORM_SIZE_BAD);
         return (DW_DLV_ERROR);
     }
 
